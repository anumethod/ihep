# Cloud Build for React Frontend deployment to Cloud Storage
steps:
  # Install dependencies
  - name: 'node:20-alpine'
    entrypoint: 'npm'
    args: ['ci']
    dir: 'client'
    
  # Build React application
  - name: 'node:20-alpine'
    entrypoint: 'npm'
    args: ['run', 'build']
    dir: 'client'
    env:
      - 'VITE_API_BASE_URL=https://api.ihep.app'
      - 'VITE_ENVIRONMENT=production'
      - 'VITE_APP_DOMAIN=https://ihep.app'
    
  # Deploy to Cloud Storage
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gsutil'
    args: ['-m', 'rsync', '-r', '-d', 'client/dist/', 'gs://$PROJECT_ID-health-insight-frontend/']
    
  # Set cache control headers
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gsutil'
    args: ['-m', 'setmeta', '-h', 'Cache-Control:public, max-age=31536000', 'gs://$PROJECT_ID-health-insight-frontend/**/*.js']
    
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gsutil'
    args: ['-m', 'setmeta', '-h', 'Cache-Control:public, max-age=31536000', 'gs://$PROJECT_ID-health-insight-frontend/**/*.css']
    
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gsutil'
    args: ['-m', 'setmeta', '-h', 'Cache-Control:public, max-age=86400', 'gs://$PROJECT_ID-health-insight-frontend/index.html']

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_4'

timeout: '600s'